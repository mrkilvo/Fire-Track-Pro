{% extends "firtrackpro/www/templates/portal_template.html" %}
{% block title %}Your Profile{% endblock %}

{% block page_content %}
<div class="w-full max-w-3xl mx-auto px-4 py-6 space-y-6">
  <div class="flex items-center gap-3">
    <img src="{{ profile.user_image or '/assets/firtrackpro/images/avatar.png' }}" class="h-12 w-12 rounded-full object-cover" alt="Avatar">
    <div>
      <div class="text-2xl font-bold">{{ profile.full_name }}</div>
      <div class="text-sm text-gray-500">{{ profile.email }}</div>
    </div>
  </div>

  <div class="bg-white rounded-xl shadow p-6 space-y-6">
    <div class="text-lg font-semibold">Contact Details</div>
    <div class="grid md:grid-cols-2 gap-4">
      <div class="space-y-2">
        <label class="text-sm font-medium">First Name</label>
        <input id="first_name" type="text" value="{{ profile.first_name }}" class="w-full rounded border px-3 py-2">
      </div>
      <div class="space-y-2">
        <label class="text-sm font-medium">Last Name</label>
        <input id="last_name" type="text" value="{{ profile.last_name }}" class="w-full rounded border px-3 py-2">
      </div>
      <div class="space-y-2">
        <label class="text-sm font-medium">Phone</label>
        <input id="phone" type="text" value="{{ profile.phone }}" class="w-full rounded border px-3 py-2">
      </div>
      <div class="space-y-2">
        <label class="text-sm font-medium">Mobile</label>
        <input id="mobile_no" type="text" value="{{ profile.mobile_no }}" class="w-full rounded border px-3 py-2">
      </div>
      <div class="space-y-2">
        <label class="text-sm font-medium">Time Zone</label>
        <input id="time_zone" type="text" value="{{ profile.time_zone }}" class="w-full rounded border px-3 py-2">
      </div>
      <div class="space-y-2">
        <label class="text-sm font-medium">Language</label>
        <input id="language" type="text" value="{{ profile.language }}" class="w-full rounded border px-3 py-2">
      </div>
    </div>
    <div class="flex justify-end">
      <button id="save_profile" class="px-4 py-2 rounded-lg border">Save</button>
    </div>
  </div>

  <div class="bg-white rounded-xl shadow p-6 space-y-4">
    <div class="text-lg font-semibold">Security</div>
    <div class="grid md:grid-cols-3 gap-4">
      <div class="space-y-2">
        <label class="text-sm font-medium">Current Password</label>
        <input id="current_password" type="password" class="w-full rounded border px-3 py-2">
      </div>
      <div class="space-y-2">
        <label class="text-sm font-medium">New Password</label>
        <input id="new_password" type="password" class="w-full rounded border px-3 py-2">
      </div>
      <div class="space-y-2">
        <label class="text-sm font-medium">Confirm Password</label>
        <input id="confirm_password" type="password" class="w-full rounded border px-3 py-2">
      </div>
    </div>
    <div class="flex justify-end">
      <button id="change_password" class="px-4 py-2 rounded-lg border">Change Password</button>
    </div>
  </div>
</div>

<script>
  async function postJSON(url, payload){
    const res = await fetch(url, {
      method: 'POST',
      headers: {'Content-Type':'application/json','X-Frappe-CSRF-Token':'{{ csrf_token }}'},
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if(!res.ok || data.exc) throw new Error(data._server_messages || data.message || 'Error');
    return data;
  }

  document.getElementById('save_profile').addEventListener('click', async ()=>{
    const payload = {
      first_name: document.getElementById('first_name').value.trim(),
      last_name: document.getElementById('last_name').value.trim(),
      phone: document.getElementById('phone').value.trim(),
      mobile_no: document.getElementById('mobile_no').value.trim(),
      time_zone: document.getElementById('time_zone').value.trim(),
      language: document.getElementById('language').value.trim()
    };
    try {
      await postJSON('/api/method/firtrackpro.api.accounts.update_profile', payload);
      if(window.Toastify){Toastify({text:'Profile saved', duration:3000}).showToast()}
    } catch(e){
      if(window.Toastify){Toastify({text:e.message, duration:4000, backgroundColor:'#DC2626'}).showToast()}
    }
  });

  document.getElementById('change_password').addEventListener('click', async ()=>{
    const current_password = document.getElementById('current_password').value;
    const new_password = document.getElementById('new_password').value;
    const confirm_password = document.getElementBy_
