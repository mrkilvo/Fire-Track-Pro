{% extends "firtrackpro/www/templates/portal_template.html" %}
{% block title %}Your Profile{% endblock %}

{% set DEMO = {
  "full_name": "Steve Kilvington",
  "email": "steve@example.com",
  "first_name": "Steve",
  "last_name": "Kilvington",
  "phone": "+61 3 9999 9999",
  "mobile_no": "+61 400 000 000",
  "time_zone": "Australia/Melbourne",
  "language": "en",
  "user_image": "/assets/firtrackpro/images/avatar.png",
  "signature_url": "/files/sample-signature.png",
  "address_line1": "10 Demo Street",
  "address_line2": "",
  "city": "Melbourne",
  "state": "VIC",
  "pincode": "3000",
  "country": "Australia",
  "lat": "-37.8136",
  "lon": "144.9631"
} %}

{% block page_content %}
<div class="w-full max-w-5xl mx-auto px-4 py-6 space-y-6">

  <!-- Header -->
  <div class="flex items-center justify-between">
    <div class="flex items-center gap-3">
      <img id="avatar_img" src="{{ (profile and profile.user_image) or DEMO.user_image }}" class="h-12 w-12 rounded-full object-cover" alt="Avatar">
      <div>
        <div class="text-2xl font-bold">{{ (profile and profile.full_name) or DEMO.full_name }}</div>
        <div class="text-sm text-gray-500">{{ (profile and profile.email) or DEMO.email }}</div>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <button id="btn_upload_avatar" class="px-3 py-2 rounded border">Upload Avatar</button>
      <input id="avatar_file" type="file" accept="image/*" class="hidden">
    </div>
  </div>

  <!-- Tabs -->
  <div class="bg-white rounded-2xl shadow">
    <div class="border-b flex overflow-x-auto">
      <button class="tab-btn px-4 py-3 text-sm font-medium border-b-2 border-transparent data-[active=true]:border-black data-[active=true]:text-black text-gray-500" data-tab="overview">Overview</button>
      <button class="tab-btn px-4 py-3 text-sm font-medium border-b-2 border-transparent data-[active=true]:border-black data-[active=true]:text-black text-gray-500" data-tab="signature">Signature</button>
      <button class="tab-btn px-4 py-3 text-sm font-medium border-b-2 border-transparent data-[active=true]:border-black data-[active=true]:text-black text-gray-500" data-tab="address">Address</button>
      <button class="tab-btn px-4 py-3 text-sm font-medium border-b-2 border-transparent data-[active=true]:border-black data-[active=true]:text-black text-gray-500" data-tab="licences">Licences</button>
      <button class="tab-btn px-4 py-3 text-sm font-medium border-b-2 border-transparent data-[active=true]:border-black data-[active=true]:text-black text-gray-500" data-tab="preferences">Preferences</button>
      <button class="tab-btn px-4 py-3 text-sm font-medium border-b-2 border-transparent data-[active=true]:border-black data-[active=true]:text-black text-gray-500" data-tab="compliance">Compliance</button>
      <button class="tab-btn px-4 py-3 text-sm font-medium border-b-2 border-transparent data-[active=true]:border-black data-[active=true]:text-black text-gray-500" data-tab="availability">Availability</button>
      <button class="tab-btn px-4 py-3 text-sm font-medium border-b-2 border-transparent data-[active=true]:border-black data-[active=true]:text-black text-gray-500" data-tab="devices">Devices</button>
      <button class="tab-btn px-4 py-3 text-sm font-medium border-b-2 border-transparent data-[active=true]:border-black data-[active=true]:text-black text-gray-500" data-tab="equipment">Equipment</button>
      <button class="tab-btn px-4 py-3 text-sm font-medium border-b-2 border-transparent data-[active=true]:border-black data-[active=true]:text-black text-gray-500" data-tab="security">Security</button>
    </div>

    <div class="p-6 space-y-6">

      <!-- OVERVIEW -->
      <section class="tab-panel" id="tab-overview">
        <div class="grid md:grid-cols-2 gap-4">
          <div class="space-y-2">
            <label class="text-sm font-medium">First Name</label>
            <input id="first_name" type="text" value="{{ (profile and profile.first_name) or DEMO.first_name }}" class="w-full rounded border px-3 py-2">
          </div>
          <div class="space-y-2">
            <label class="text-sm font-medium">Last Name</label>
            <input id="last_name" type="text" value="{{ (profile and profile.last_name) or DEMO.last_name }}" class="w-full rounded border px-3 py-2">
          </div>
          <div class="space-y-2">
            <label class="text-sm font-medium">Phone</label>
            <input id="phone" type="text" value="{{ (profile and profile.phone) or DEMO.phone }}" class="w-full rounded border px-3 py-2">
          </div>
          <div class="space-y-2">
            <label class="text-sm font-medium">Mobile</label>
            <input id="mobile_no" type="text" value="{{ (profile and profile.mobile_no) or DEMO.mobile_no }}" class="w-full rounded border px-3 py-2">
          </div>
          <div class="space-y-2">
            <label class="text-sm font-medium">Time Zone</label>
            <input id="time_zone" type="text" value="{{ (profile and profile.time_zone) or DEMO.time_zone }}" class="w-full rounded border px-3 py-2">
          </div>
          <div class="space-y-2">
            <label class="text-sm font-medium">Language</label>
            <input id="language" type="text" value="{{ (profile and profile.language) or DEMO.language }}" class="w-full rounded border px-3 py-2">
          </div>
        </div>
        <div class="flex justify-end">
          <button id="save_profile" class="px-4 py-2 rounded-lg border">Save</button>
        </div>
      </section>

      <!-- SIGNATURE -->
      <section class="tab-panel hidden" id="tab-signature">
        <div class="flex items-center justify-between">
          <div class="text-lg font-semibold">Signature</div>
          <div class="flex items-center gap-2">
            <button id="sig_upload" class="px-3 py-2 rounded border">Upload Image</button>
            <input id="signature_file" type="file" accept="image/*" class="hidden">
            <button id="sig_clear" class="px-3 py-2 rounded border">Clear</button>
            <button id="sig_save" class="px-3 py-2 rounded bg-blue-600 text-white">Save</button>
          </div>
        </div>
        <div class="grid md:grid-cols-2 gap-4 items-center">
          <div class="border rounded p-2">
            <canvas id="sig_canvas" class="w-full h-40 touch-none"></canvas>
          </div>
          <div class="flex items-center gap-4">
            <img id="signature_img" src="{{ signature_url or DEMO.signature_url }}" class="w-44 h-16 object-contain border rounded bg-gray-50" alt="Signature">
            <div class="text-xs text-gray-500">Draw in the box or upload, then Save.</div>
          </div>
        </div>
      </section>

      <!-- ADDRESS -->
      <section class="tab-panel hidden" id="tab-address">
        <div class="space-y-2 relative">
          <label class="text-sm font-medium">Search Address</label>
          <input type="text" id="addr_search" placeholder="Start typing..." class="w-full rounded border px-3 py-2" value="{{ (address and address.address_line1) or DEMO.address_line1 }} {{ (address and address.city) or DEMO.city }} {{ (address and address.state) or DEMO.state }} {{ (address and address.pincode) or DEMO.pincode }}">
          <div id="addr_results" class="absolute z-20 top-full left-0 right-0 bg-white border rounded shadow max-h-64 overflow-y-auto hidden"></div>
        </div>

        <input type="hidden" id="addr_name" value="{{ (address and address.name) or '' }}">
        <div class="grid md:grid-cols-2 gap-4 mt-4">
          <div class="space-y-2">
            <label class="text-sm font-medium">Address Line 1</label>
            <input id="addr_line1" type="text" class="w-full rounded border px-3 py-2" value="{{ (address and address.address_line1) or DEMO.address_line1 }}">
          </div>
          <div class="space-y-2">
            <label class="text-sm font-medium">Address Line 2</label>
            <input id="addr_line2" type="text" class="w-full rounded border px-3 py-2" value="{{ (address and address.address_line2) or DEMO.address_line2 }}">
          </div>
          <div class="space-y-2">
            <label class="text-sm font-medium">City / Suburb</label>
            <input id="addr_city" type="text" class="w-full rounded border px-3 py-2" value="{{ (address and address.city) or DEMO.city }}">
          </div>
          <div class="space-y-2">
            <label class="text-sm font-medium">State</label>
            <input id="addr_state" type="text" class="w-full rounded border px-3 py-2" value="{{ (address and address.state) or DEMO.state }}">
          </div>
          <div class="space-y-2">
            <label class="text-sm font-medium">Postcode</label>
            <input id="addr_pincode" type="text" class="w-full rounded border px-3 py-2" value="{{ (address and address.pincode) or DEMO.pincode }}">
          </div>
          <div class="space-y-2">
            <label class="text-sm font-medium">Country</label>
            <input id="addr_country" type="text" class="w-full rounded border px-3 py-2" value="{{ (address and address.country) or DEMO.country }}">
          </div>
          <div class="space-y-2">
            <label class="text-sm font-medium">Latitude (optional)</label>
            <input id="addr_lat" type="text" class="w-full rounded border px-3 py-2" value="{{ (address and (address.latitude or address.lat)) or DEMO.lat }}">
          </div>
          <div class="space-y-2">
            <label class="text-sm font-medium">Longitude (optional)</label>
            <input id="addr_lon" type="text" class="w-full rounded border px-3 py-2" value="{{ (address and (address.longitude or address.lon)) or DEMO.lon }}">
          </div>
        </div>
        <div class="flex justify-end">
          <button id="addr_save" class="px-4 py-2 rounded-lg border mt-2">Save Address</button>
        </div>
      </section>

      <!-- LICENCES -->
      <section class="tab-panel hidden" id="tab-licences">
        <div class="flex items-center justify-between">
          <div class="text-lg font-semibold">Licences & Accreditations</div>
          <button id="btn_add_licence" class="px-3 py-2 rounded border">Add New</button>
        </div>
        <table class="w-full text-sm table-auto border-collapse mt-3">
          <thead>
            <tr class="bg-gray-100">
              <th class="px-3 py-2 text-left font-semibold">Type</th>
              <th class="px-3 py-2 text-left font-semibold">Number</th>
              <th class="px-3 py-2 text-left font-semibold">Expiry</th>
            </tr>
          </thead>
          <tbody id="licences_tbody">
            {% set LICS = licences or [
              {"ftp_user_accreditation_type":"FPAA Inspect/Test","ftp_user_accreditation_number":"FPA-12345","ftp_user_accreditation_expiry_date":"2026-06-30"},
              {"ftp_user_accreditation_type":"Working at Heights","ftp_user_accreditation_number":"WAH-99887","ftp_user_accreditation_expiry_date":"2025-12-31"}
            ] %}
            {% for lic in LICS %}
            <tr class="border-b">
              <td class="px-3 py-2">{{ lic.ftp_user_accreditation_type or lic.accreditation_type }}</td>
              <td class="px-3 py-2">{{ lic.ftp_user_accreditation_number or lic.accreditation_number }}</td>
              <td class="px-3 py-2">{{ lic.ftp_user_accreditation_expiry_date or lic.expiry_date }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </section>

      <!-- PREFERENCES -->
      <section class="tab-panel hidden" id="tab-preferences">
        <div class="grid md:grid-cols-2 gap-4">
          <label class="flex items-center gap-2"><input type="checkbox" id="pref_email" checked> <span>Email</span></label>
          <label class="flex items-center gap-2"><input type="checkbox" id="pref_push" checked> <span>Push</span></label>
          <label class="flex items-center gap-2"><input type="checkbox" id="pref_sms"> <span>SMS</span></label>
          <label class="flex items-center gap-2"><input type="checkbox" id="pref_daily"> <span>Daily Digest</span></label>
          <label class="flex items-center gap-2"><input type="checkbox" id="pref_weekly" checked> <span>Weekly Report</span></label>
          <div class="space-y-2">
            <label class="text-sm font-medium">Default Company</label>
            <input id="pref_company" type="text" class="w-full rounded border px-3 py-2" value="">
          </div>
          <div class="space-y-2">
            <label class="text-sm font-medium">Default Cost Center</label>
            <input id="pref_cost_center" type="text" class="w-full rounded border px-3 py-2" value="">
          </div>
          <div class="md:col-span-2 space-y-2">
            <label class="text-sm font-medium">Notes</label>
            <textarea id="pref_notes" class="w-full rounded border px-3 py-2" rows="3"></textarea>
          </div>
        </div>
        <div class="flex justify-end">
          <button id="prefs_save" class="px-4 py-2 rounded-lg border">Save Preferences</button>
        </div>
      </section>

      <!-- COMPLIANCE -->
      <section class="tab-panel hidden" id="tab-compliance">
        <div class="grid md:grid-cols-2 gap-4">
          <div class="space-y-2"><label class="text-sm font-medium">Police Check #</label><input id="cmp_police_no" type="text" class="w-full rounded border px-3 py-2"></div>
          <div class="space-y-2"><label class="text-sm font-medium">Police Check Expiry</label><input id="cmp_police_exp" type="date" class="w-full rounded border px-3 py-2"></div>
          <div class="space-y-2"><label class="text-sm font-medium">WWC #</label><input id="cmp_wwc_no" type="text" class="w-full rounded border px-3 py-2"></div>
          <div class="space-y-2"><label class="text-sm font-medium">WWC Expiry</label><input id="cmp_wwc_exp" type="date" class="w-full rounded border px-3 py-2"></div>
          <div class="space-y-2"><label class="text-sm font-medium">Medical Clearance Expiry</label><input id="cmp_med_exp" type="date" class="w-full rounded border px-3 py-2"></div>
          <div class="space-y-2"><label class="text-sm font-medium">Driver Licence #</label><input id="cmp_dl_no" type="text" class="w-full rounded border px-3 py-2"></div>
          <div class="space-y-2"><label class="text-sm font-medium">Driver Licence Expiry</label><input id="cmp_dl_exp" type="date" class="w-full rounded border px-3 py-2"></div>
          <div class="space-y-2"><label class="text-sm font-medium">Driver Licence Class</label><input id="cmp_dl_class" type="text" class="w-full rounded border px-3 py-2"></div>
          <div class="space-y-2"><label class="text-sm font-medium">Driver Licence State</label><input id="cmp_dl_state" type="text" class="w-full rounded border px-3 py-2"></div>
        </div>
        <div class="flex justify-end">
          <button id="cmp_save" class="px-4 py-2 rounded-lg border">Save Compliance</button>
        </div>
      </section>

      <!-- AVAILABILITY -->
      <section class="tab-panel hidden" id="tab-availability">
        <div class="flex items-center justify-between">
          <div class="text-lg font-semibold">Weekly Availability</div>
          <button id="btn_add_avail" class="px-3 py-2 rounded border">Add</button>
        </div>
        <table class="w-full text-sm table-auto border-collapse mt-3">
          <thead><tr class="bg-gray-100"><th class="px-3 py-2 text-left">Day</th><th class="px-3 py-2 text-left">Start</th><th class="px-3 py-2 text-left">End</th><th class="px-3 py-2 text-left">Available</th></tr></thead>
          <tbody id="avail_tbody">
            <tr class="border-b"><td class="px-3 py-2">Mon</td><td class="px-3 py-2">08:00:00</td><td class="px-3 py-2">16:00:00</td><td class="px-3 py-2">Yes</td></tr>
            <tr class="border-b"><td class="px-3 py-2">Tue</td><td class="px-3 py-2">08:00:00</td><td class="px-3 py-2">16:00:00</td><td class="px-3 py-2">Yes</td></tr>
          </tbody>
        </table>
      </section>

      <!-- DEVICES -->
      <section class="tab-panel hidden" id="tab-devices">
        <div class="flex items-center justify-between">
          <div class="text-lg font-semibold">Devices</div>
          <button id="btn_add_device" class="px-3 py-2 rounded border">Add</button>
        </div>
        <table class="w-full text-sm table-auto border-collapse mt-3">
          <thead><tr class="bg-gray-100"><th class="px-3 py-2 text-left">Platform</th><th class="px-3 py-2 text-left">Device ID</th><th class="px-3 py-2 text-left">Last Seen</th></tr></thead>
          <tbody id="devices_tbody">
            <tr class="border-b"><td class="px-3 py-2">Android</td><td class="px-3 py-2">demo-device-1</td><td class="px-3 py-2"></td></tr>
          </tbody>
        </table>
      </section>

      <!-- EQUIPMENT -->
      <section class="tab-panel hidden" id="tab-equipment">
        <div class="flex items-center justify-between">
          <div class="text-lg font-semibold">Issued Equipment</div>
          <button id="btn_add_equipment" class="px-3 py-2 rounded border">Add</button>
        </div>
        <table class="w-full text-sm table-auto border-collapse mt-3">
          <thead><tr class="bg-gray-100"><th class="px-3 py-2 text-left">Asset</th><th class="px-3 py-2 text-left">Serial</th><th class="px-3 py-2 text-left">Issued</th><th class="px-3 py-2 text-left">Returned</th><th class="px-3 py-2 text-left">Condition</th></tr></thead>
          <tbody id="equip_tbody">
            <tr class="border-b"><td class="px-3 py-2">Fire Extinguisher</td><td class="px-3 py-2">SER-001</td><td class="px-3 py-2">2025-08-01</td><td class="px-3 py-2"></td><td class="px-3 py-2">Good</td></tr>
          </tbody>
        </table>
      </section>

      <!-- SECURITY -->
      <section class="tab-panel hidden" id="tab-security">
        <div class="grid md:grid-cols-3 gap-4">
          <div class="space-y-2"><label class="text-sm font-medium">Current Password</label><input id="current_password" type="password" class="w-full rounded border px-3 py-2"></div>
          <div class="space-y-2"><label class="text-sm font-medium">New Password</label><input id="new_password" type="password" class="w-full rounded border px-3 py-2"></div>
          <div class="space-y-2"><label class="text-sm font-medium">Confirm Password</label><input id="confirm_password" type="password" class="w-full rounded border px-3 py-2"></div>
        </div>
        <div class="flex justify-end"><button id="change_password" class="px-4 py-2 rounded-lg border">Change Password</button></div>
      </section>

    </div>
  </div>

</div>

<!-- Add Licence Modal -->
<div id="licence_modal" class="fixed inset-0 hidden items-center justify-center z-50">
  <div class="absolute inset-0 bg-black bg-opacity-40"></div>
  <div class="relative bg-white rounded-xl shadow p-6 w-full max-w-md">
    <div class="text-lg font-semibold mb-4">Add Licence</div>
    <div class="space-y-3">
      <div class="space-y-1"><label class="text-sm">Type</label><input id="lic_type" type="text" class="w-full rounded border px-3 py-2"></div>
      <div class="space-y-1"><label class="text-sm">Number</label><input id="lic_number" type="text" class="w-full rounded border px-3 py-2"></div>
      <div class="space-y-1"><label class="text-sm">Expiry</label><input id="lic_expiry" type="date" class="w-full rounded border px-3 py-2"></div>
    </div>
    <div class="flex items-center justify-end gap-2 mt-5">
      <button id="lic_cancel" class="px-3 py-2 rounded border">Cancel</button>
      <button id="lic_save" class="px-3 py-2 rounded bg-blue-600 text-white">Save</button>
    </div>
  </div>
</div>

<script>
/* ---- Tabs ---- */
const tabs = Array.from(document.querySelectorAll('.tab-btn'));
const panels = Array.from(document.querySelectorAll('.tab-panel'));
function activateTab(key){tabs.forEach(b=>b.dataset.active=(b.dataset.tab===key));panels.forEach(p=>p.classList.toggle('hidden',p.id!=='tab-'+key));localStorage.setItem('ftp_profile_tab',key)}
activateTab(localStorage.getItem('ftp_profile_tab')||'overview');
tabs.forEach(b=>b.addEventListener('click',()=>activateTab(b.dataset.tab)));

/* ---- Helpers ---- */
async function postJSON(url, payload){
  try{
    const res=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json','X-Frappe-CSRF-Token':'{{ csrf_token or "" }}'},body:JSON.stringify(payload)});
    const data=await res.json(); if(!res.ok||data.exc) throw new Error(data._server_messages||data.message||'Error'); return data;
  }catch(e){
    // In demo-only mode, we just simulate success
    console.warn('postJSON demo fallback:', url, payload, e.message);
    return {message:'demo-ok'};
  }
}
function toast(msg, error){ if(window.Toastify){Toastify({text:msg,duration:3000,backgroundColor:error?'#DC2626':undefined}).showToast()} else { alert(msg) } }
async function postFile(url, file){
  try{
    const fd=new FormData(); fd.append('file',file);
    const res=await fetch(url,{method:'POST',headers:{'X-Frappe-CSRF-Token':'{{ csrf_token or "" }}'},body:fd});
    const data=await res.json(); if(!res.ok||data.exc) throw new Error(data._server_messages||data.message||'Error'); return data;
  }catch(e){
    console.warn('postFile demo fallback:', url, file?.name, e.message);
    // demo: return a local object URL so preview works
    return {file_url: URL.createObjectURL(file)};
  }
}

/* ---- Overview -> Save basic profile (demo) ---- */
const fn=document.getElementById('first_name'), ln=document.getElementById('last_name'), ph=document.getElementById('phone'), mb=document.getElementById('mobile_no'), tz=document.getElementById('time_zone'), lang=document.getElementById('language');
document.getElementById('save_profile').addEventListener('click', async ()=>{
  await postJSON('/api/method/firtrackpro.api.accounts.update_profile',{first_name:fn.value.trim(),last_name:ln.value.trim(),phone:ph.value.trim(),mobile_no:mb.value.trim(),time_zone:tz.value.trim(),language:lang.value.trim()});
  toast('Profile saved');
});

/* ---- Avatar upload (preview-first; posts if backend exists) ---- */
document.getElementById('btn_upload_avatar').addEventListener('click',()=>document.getElementById('avatar_file').click());
document.getElementById('avatar_file').addEventListener('change', async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  // Instant preview
  const reader=new FileReader(); reader.onload=()=>document.getElementById('avatar_img').src=reader.result; reader.readAsDataURL(f);
  try{const r=await postFile('/api/method/firtrackpro.api.accounts.upload_avatar',f); if(r.file_url && !r.file_url.startsWith('blob:')) document.getElementById('avatar_img').src=r.file_url; toast('Avatar updated');}catch(err){toast(err.message,true)}
});

/* ---- Signature upload + pad ---- */
document.getElementById('sig_upload').addEventListener('click',()=>document.getElementById('signature_file').click());
document.getElementById('signature_file').addEventListener('change', async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  const reader=new FileReader(); reader.onload=()=>document.getElementById('signature_img').src=reader.result; reader.readAsDataURL(f);
  try{const r=await postFile('/api/method/firtrackpro.api.accounts.upload_signature',f); if(r.file_url && !r.file_url.startsWith('blob:')) document.getElementById('signature_img').src=r.file_url; toast('Signature updated');}catch(err){toast(err.message,true)}
});
const canvas=document.getElementById('sig_canvas'); const ctx=canvas.getContext('2d');
function resizeCanvas(){const ratio=Math.max(window.devicePixelRatio||1,1); const rect=canvas.getBoundingClientRect(); canvas.width=rect.width*ratio; canvas.height=rect.height*ratio; ctx.setTransform(1,0,0,1,0,0); ctx.scale(ratio,ratio); ctx.lineWidth=2; ctx.lineCap='round'; ctx.lineJoin='round'; ctx.strokeStyle='#111827'; ctx.clearRect(0,0,rect.width,rect.height)}
function cRect(){return canvas.getBoundingClientRect()}
resizeCanvas(); window.addEventListener('resize',resizeCanvas);
let drawing=false,lastX=0,lastY=0;
function startDraw(x,y){drawing=true; lastX=x; lastY=y}
function draw(x,y){if(!drawing)return; ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(x,y); ctx.stroke(); lastX=x; lastY=y}
function endDraw(){drawing=false}
canvas.addEventListener('mousedown',e=>startDraw(e.offsetX,e.offsetY));
canvas.addEventListener('mousemove',e=>draw(e.offsetX,e.offsetY));
canvas.addEventListener('mouseup',endDraw); canvas.addEventListener('mouseleave',endDraw);
canvas.addEventListener('touchstart',e=>{const t=e.touches[0]; const r=cRect(); startDraw(t.clientX-r.left,t.clientY-r.top); e.preventDefault()},{passive:false});
canvas.addEventListener('touchmove',e=>{const t=e.touches[0]; const r=cRect(); draw(t.clientX-r.left,t.clientY-r.top); e.preventDefault()},{passive:false});
canvas.addEventListener('touchend',endDraw);
document.getElementById('sig_clear').addEventListener('click',()=>{const r=cRect(); ctx.clearRect(0,0,r.width,r.height)});
document.getElementById('sig_save').addEventListener('click', async ()=>{
  const dataURL=canvas.toDataURL('image/png');
  document.getElementById('signature_img').src=dataURL; // instant demo
  try{await postJSON('/api/method/firtrackpro.api.accounts.save_signature_dataurl',{data_url:dataURL}); toast('Signature saved');}catch(e){toast('Signature saved (demo)',false)}
});

/* ---- Address lookup (Nominatim) ---- */
const addrSearch=document.getElementById('addr_search'), addrResults=document.getElementById('addr_results');
const line1=document.getElementById('addr_line1'), line2=document.getElementById('addr_line2'), city=document.getElementById('addr_city'), state=document.getElementById('addr_state'), pin=document.getElementById('addr_pincode'), country=document.getElementById('addr_country'), lat=document.getElementById('addr_lat'), lon=document.getElementById('addr_lon');
let addrTimer;
function hideRes(){addrResults.classList.add('hidden')}
function showRes(){addrResults.classList.remove('hidden')}
function pick(addr,keys){for(const k of keys){if(addr[k]) return addr[k]} return ''}
function applyNominatim(item){
  const a=item.address||{};
  const house=pick(a,['house_number']); const road=pick(a,['road','pedestrian','path','footway']);
  line1.value=[house,road].filter(Boolean).join(' ') || (item.name||'');
  line2.value='';
  city.value=pick(a,['suburb','city','town','village','locality']);
  state.value=pick(a,['state','state_district','region']);
  pin.value=pick(a,['postcode']);
  country.value=pick(a,['country'])||'Australia';
  lat.value=item.lat||''; lon.value=item.lon||'';
  addrSearch.value=item.display_name||'';
  hideRes();
}
function renderResults(items){
  addrResults.innerHTML=items.map(it=>`<div class="px-3 py-2 hover:bg-gray-100 cursor-pointer">${it.display_name||''}</div>`).join('');
  if(items.length) showRes(); else hideRes();
  Array.from(addrResults.children).forEach((row,idx)=>row.addEventListener('click',()=>applyNominatim(items[idx])));
}
async function searchAddress(q){
  try{
    const url=`https://nominatim.openstreetmap.org/search?format=jsonv2&addressdetails=1&countrycodes=au&q=${encodeURIComponent(q)}&email=${encodeURIComponent('{{ (profile and profile.email) or DEMO.email }}')}`;
    const res=await fetch(url); if(!res.ok) throw new Error('lookup failed');
    const data=await res.json(); renderResults(data);
  }catch(e){
    console.warn('Nominatim demo fallback', e.message);
    renderResults([]); // silent
  }
}
addrSearch.addEventListener('input',()=>{
  clearTimeout(addrTimer); const q=addrSearch.value.trim(); if(q.length<3){hideRes();return}
  addrTimer=setTimeout(()=>searchAddress(q),400);
});
document.addEventListener('click',e=>{if(!addrResults.contains(e.target)&&e.target!==addrSearch) hideRes()});
addrSearch.addEventListener('focus',()=>{if(addrResults.innerHTML.trim()) showRes()});
document.getElementById('addr_save').addEventListener('click', async ()=>{
  await postJSON('/api/method/firtrackpro.api.accounts.save_user_address',{
    address_name: document.getElementById('addr_name').value || '',
    address_title: 'Primary',
    address_line1: line1.value.trim(),
    address_line2: line2.value.trim(),
    city: city.value.trim(),
    state: state.value.trim(),
    pincode: pin.value.trim(),
    country: country.value.trim() || 'Australia',
    lat: lat.value.trim(),
    lon: lon.value.trim()
  });
  toast('Address saved');
});

/* ---- Licences (demo) ---- */
const licModal=document.getElementById('licence_modal');
document.getElementById('btn_add_licence').addEventListener('click',()=>{licModal.classList.remove('hidden');licModal.classList.add('flex')});
document.getElementById('lic_cancel').addEventListener('click',()=>{licModal.classList.add('hidden');licModal.classList.remove('flex')});
document.getElementById('lic_save').addEventListener('click', async ()=>{
  const type=document.getElementById('lic_type').value.trim(), number=document.getElementById('lic_number').value.trim(), expiry=document.getElementById('lic_expiry').value;
  if(!type||!number||!expiry){toast('All fields required',true);return}
  try{await postJSON('/api/method/firtrackpro.api.accounts.add_accreditation',{accreditation_type:type,accreditation_number:number,expiry_date:expiry});}catch(_){}
  const tr=document.createElement('tr'); tr.className='border-b'; tr.innerHTML=`<td class="px-3 py-2">${type}</td><td class="px-3 py-2">${number}</td><td class="px-3 py-2">${expiry}</td>`;
  document.getElementById('licences_tbody').appendChild(tr);
  licModal.classList.add('hidden'); licModal.classList.remove('flex');
  document.getElementById('lic_type').value=''; document.getElementById('lic_number').value=''; document.getElementById('lic_expiry').value='';
  toast('Licence added');
});

/* ---- Preferences (demo) ---- */
document.getElementById('prefs_save').addEventListener('click', async ()=>{
  try{
    await postJSON('/api/method/firtrackpro.api.accounts.save_profile_preferences',{
      ftp_user_profile_notify_email: document.getElementById('pref_email').checked ? 1 : 0,
      ftp_user_profile_notify_push: document.getElementById('pref_push').checked ? 1 : 0,
      ftp_user_profile_notify_sms: document.getElementById('pref_sms').checked ? 1 : 0,
      ftp_user_profile_daily_digest: document.getElementById('pref_daily').checked ? 1 : 0,
      ftp_user_profile_weekly_report: document.getElementById('pref_weekly').checked ? 1 : 0,
      ftp_user_profile_default_company: document.getElementById('pref_company').value.trim(),
      ftp_user_profile_default_cost_center: document.getElementById('pref_cost_center').value.trim(),
      ftp_user_profile_notes: document.getElementById('pref_notes').value
    });
  }catch(_){}
  toast('Preferences saved');
});

/* ---- Compliance (demo) ---- */
document.getElementById('cmp_save').addEventListener('click', async ()=>{
  try{
    await postJSON('/api/method/firtrackpro.api.accounts.save_profile_compliance',{
      ftp_user_profile_police_check_number: document.getElementById('cmp_police_no').value.trim(),
      ftp_user_profile_police_check_expiry: document.getElementById('cmp_police_exp').value,
      ftp_user_profile_wwc_number: document.getElementById('cmp_wwc_no').value.trim(),
      ftp_user_profile_wwc_expiry: document.getElementById('cmp_wwc_exp').value,
      ftp_user_profile_medical_clearance_expiry: document.getElementById('cmp_med_exp').value,
      ftp_user_profile_driver_licence_no: document.getElementById('cmp_dl_no').value.trim(),
      ftp_user_profile_driver_licence_expiry: document.getElementById('cmp_dl_exp').value,
      ftp_user_profile_driver_licence_class: document.getElementById('cmp_dl_class').value.trim(),
      ftp_user_profile_driver_licence_state: document.getElementById('cmp_dl_state').value.trim()
    });
  }catch(_){}
  toast('Compliance saved');
});

/* ---- Availability / Devices / Equipment (demo prompt add) ---- */
document.getElementById('btn_add_avail').addEventListener('click', async ()=>{
  const day=prompt('Day (Mon..Sun):','Wed'); if(!day) return;
  const start=prompt('Start time (HH:MM):','07:30'); const end=prompt('End time (HH:MM):','15:30');
  try{await postJSON('/api/method/firtrackpro.api.accounts.add_availability',{day_of_week:day,start_time:start?start+':00':null,end_time:end?end+':00':null,is_available:1});}catch(_){}
  const tr=document.createElement('tr'); tr.className='border-b'; tr.innerHTML=`<td class="px-3 py-2">${day}</td><td class="px-3 py-2">${start}:00</td><td class="px-3 py-2">${end}:00</td><td class="px-3 py-2">Yes</td>`;
  document.getElementById('avail_tbody').appendChild(tr);
});
document.getElementById('btn_add_device').addEventListener('click', async ()=>{
  const platform=prompt('Platform (iOS/Android/Web):','iOS'); if(!platform) return;
  const id=prompt('Device ID:','demo-device-2'); if(!id) return;
  try{await postJSON('/api/method/firtrackpro.api.accounts.add_device',{platform,identifier:id});}catch(_){}
  const tr=document.createElement('tr'); tr.className='border-b'; tr.innerHTML=`<td class="px-3 py-2">${platform}</td><td class="px-3 py-2">${id}</td><td class="px-3 py-2"></td>`;
  document.getElementById('devices_tbody').appendChild(tr);
});
document.getElementById('btn_add_equipment').addEventListener('click', async ()=>{
  const asset=prompt('Asset Name/Code:','Torch'); if(!asset) return;
  const serial=prompt('Serial No:','SER-002'); const issued=prompt('Issued On (YYYY-MM-DD):','2025-08-10');
  try{await postJSON('/api/method/firtrackpro.api.accounts.add_equipment',{asset,serial_no:serial,issued_on:issued});}catch(_){}
  const tr=document.createElement('tr'); tr.className='border-b'; tr.innerHTML=`<td class="px-3 py-2">${asset}</td><td class="px-3 py-2">${serial||''}</td><td class="px-3 py-2">${issued||''}</td><td class="px-3 py-2"></td><td class="px-3 py-2">Good</td>`;
  document.getElementById('equip_tbody').appendChild(tr);
});

/* ---- Security (demo) ---- */
const cp=document.getElementById('current_password'), npw=document.getElementById('new_password'), cfp=document.getElementById('confirm_password');
document.getElementById('change_password').addEventListener('click', async ()=>{
  const cur=cp.value, np=npw.value, cf=cfp.value; if(!np||np!==cf){toast('Passwords do not match',true);return}
  try{await postJSON('/api/method/firtrackpro.api.accounts.change_password',{current_password:cur,new_password:np}); toast('Password updated'); cp.value=npw.value=cfp.value='';}catch(_){toast('Password updated (demo)'); cp.value=npw.value=cfp.value=''}
});

if(window.feather){feather.replace()}
</script>
{% endblock %}
