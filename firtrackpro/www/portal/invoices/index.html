{% extends "firtrackpro/www/templates/portal_base.html" %}
{% block title %}Invoices{% endblock %}
{% block portal_content %}
<div class="w-full max-w-7xl mx-auto px-4 md:px-6 py-6 space-y-4">
  <div class="bg-white border border-line rounded-2xl p-4 shadow-ft1">
    <div class="flex items-center justify-between mb-3">
      <div class="text-xl font-semibold text-ink">Invoices</div>
      <div class="flex items-center gap-2">
        <input id="q" class="border px-3 py-2 rounded" placeholder="Search invoices...">
      </div>
    </div>
    <table class="min-w-full table-auto">
      <thead>
        <tr class="bg-gray-100 text-xs text-gray-700 uppercase">
          <th class="px-4 py-2 text-left">Invoice</th>
          <th class="px-4 py-2 text-left">Customer</th>
          <th class="px-4 py-2 text-left">Status</th>
          <th class="px-4 py-2 text-left">Total</th>
          <th class="px-4 py-2 text-left">Updated</th>
          <th class="px-4 py-2 text-left"></th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>
</div>

<!-- Slide-over drawer -->
<div id="invDrawer" class="fixed inset-y-0 right-0 w-full max-w-md bg-white border-l border-line shadow-ft2 translate-x-full transition-transform duration-200 z-50" aria-hidden="true">
  <div class="h-full flex flex-col">
    <div class="flex items-center justify-between px-4 py-3 border-b">
      <div class="font-semibold text-ink" id="d_title">Invoice</div>
      <button class="rounded-lg border px-3 py-1" data-drawer-close="invDrawer">Close</button>
    </div>
    <div class="p-4 space-y-3 flex-1 overflow-auto">
      <div class="text-sm text-muted" id="d_meta"></div>
      <div class="text-sm" id="d_status"></div>
      <div class="bg-panelweak rounded-xl p-3 border border-line">
        <div class="text-sm font-semibold mb-1">Line items</div>
        <ul id="d_lines" class="text-sm list-disc pl-5"></ul>
      </div>
      <div>
        <button class="bg-brand text-white rounded-xl px-3 py-2 hover:bg-brand-600">Send/Resend</button>
        <button class="bg-white border border-line rounded-xl px-3 py-2 ml-2">Download PDF</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block script %}
{{ super() }}
<script src="/assets/firtrackpro/js/portal-demo.js"></script>
<script>
(function(){
  const data = {{ INVOICES | tojson }};
  const rowsEl = document.getElementById('rows');
  const q = document.getElementById('q');

  function render(list){
    rowsEl.innerHTML = list.map(r=>`
      <tr class="hover:bg-gray-50">
        <td class="px-4 py-2 font-mono">${r.id}</td>
        <td class="px-4 py-2">${r.customer}</td>
        <td class="px-4 py-2">${FTP.badge(r.status)}</td>
        <td class="px-4 py-2 text-right tabular-nums">${r.total}</td>
        <td class="px-4 py-2 text-muted">${r.updated}</td>
        <td class="px-4 py-2 text-right">
          <a href="#" class="text-blue-600 hover:underline" data-id="${r.id}" data-drawer-open="invDrawer">View</a>
        </td>
      </tr>`).join('');
  }
  render(data);

  q.addEventListener('input', ()=>{
    const v=q.value.toLowerCase();
    render(data.filter(r => (r.id+r.customer+r.status).toLowerCase().includes(v)));
  });

  document.addEventListener('click', (e)=>{
    const a = e.target.closest('[data-drawer-open="invDrawer"][data-id]');
    if(!a) return;
    e.preventDefault();
    const id = a.getAttribute('data-id');
    const r = data.find(x=>x.id===id); if(!r) return;
    document.getElementById('d_title').textContent = r.id + ' — ' + r.customer;
    document.getElementById('d_meta').textContent = `Total ${r.total} • Updated ${r.updated}`;
    document.getElementById('d_status').innerHTML = FTP.badge(r.status);
    const L = document.getElementById('d_lines');
    L.innerHTML = '';
    const items = [
      'Labour — Technician (2h)',
      'Fire Panel Testing — Callout',
      'Consumables — Fuses & Cable',
      'Travel — Zone 2'
    ];
    items.forEach(x => { const li=document.createElement('li'); li.textContent=x; L.appendChild(li); });
  });
})();
</script>
{% endblock %}
