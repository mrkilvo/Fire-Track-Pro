{% extends "firtrackpro/www/templates/portal_base.html" %}
{% block title %}Scheduler{% endblock %}

{% block portal_content %}
<div class="w-full max-w-[1400px] mx-auto px-4 md:px-6 py-6 space-y-4">

  <!-- Toolbar -->
  <div class="bg-white border border-line rounded-2xl p-4 shadow-ft1">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <!-- left: nav -->
      <div class="flex items-center gap-2">
        <button id="btn_prev"  class="bg-white border border-line rounded-xl px-3 py-2">Prev</button>
        <button id="btn_today" class="bg-white border border-line rounded-xl px-3 py-2">Today</button>
        <button id="btn_next"  class="bg-white border border-line rounded-xl px-3 py-2">Next</button>
      </div>

      <!-- centre: view switcher (includes all core Scheduler views youâ€™ll likely use) -->
      <div class="flex flex-wrap items-center gap-2">
        <button data-view="resourceTimelineDay"   class="viewbtn bg-white border border-line rounded-xl px-3 py-2">Timeline Day</button>
        <button data-view="resourceTimelineWeek"  class="viewbtn bg-white border border-line rounded-xl px-3 py-2">Timeline Week</button>
        <button data-view="resourceTimelineMonth" class="viewbtn bg-white border border-line rounded-xl px-3 py-2">Timeline Month</button>
        <button data-view="resourceTimeGridDay"   class="viewbtn bg-white border border-line rounded-xl px-3 py-2">Grid Day</button>
        <button data-view="resourceTimeGridWeek"  class="viewbtn bg-white border border-line rounded-xl px-3 py-2">Grid Week</button>
        <button data-view="dayGridMonth"          class="viewbtn bg-white border border-line rounded-xl px-3 py-2">Month</button>
      </div>

      <!-- right: filters & new -->
      <div class="flex flex-wrap items-center gap-2">
        <!-- quick resource filter (multi-select) -->
        <div class="relative">
          <button id="tech_filter_btn" class="bg-white border border-line rounded-xl px-3 py-2 min-w-[160px] text-left">
            <span class="align-middle">Filter techniciansâ€¦</span>
          </button>
          <div id="tech_filter_menu" class="hidden absolute right-0 mt-1 z-20 bg-white border border-line rounded-xl shadow-ft2 w-64 max-h-72 overflow-auto p-2">
            <div class="mb-1 px-1 text-xs text-muted">Show in timeline</div>
            <div id="tech_checklist" class="space-y-1"></div>
            <div class="mt-2 flex justify-end gap-2">
              <button id="tech_filter_clear" class="bg-white border border-line rounded-lg px-2 py-1 text-sm">Clear</button>
              <button id="tech_filter_apply" class="bg-brand text-white rounded-lg px-2.5 py-1 text-sm hover:bg-brand-600">Apply</button>
            </div>
          </div>
        </div>

        <select id="status_filter" class="border rounded px-3 py-2">
          <option value="">All statuses</option>
          {% for s in STATUS_OPTIONS %}<option value="{{ s }}">{{ s }}</option>{% endfor %}
        </select>
        <button id="btn_new" class="bg-brand text-white rounded-xl px-3 py-2 hover:bg-brand-600">New Job</button>
      </div>
    </div>

    <div class="mt-2 text-xs text-muted">
      Tip: in <strong>Timeline</strong> views you can scroll horizontally. Use trackpad/Shift+wheel to pan time.
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">
    <!-- Backlog (external drag source) -->
    <div class="lg:col-span-3">
      <div class="bg-white border border-line rounded-2xl p-4 shadow-ft1">
        <div class="font-semibold text-ink mb-2">Unassigned</div>
        <div id="backlog" class="space-y-2">
          {% for b in BACKLOG %}
          <div class="ext-event border border-line rounded-lg p-2 cursor-move bg-panelweak"
               data-title="{{ b.title }}" data-status="{{ b.status }}" data-site="{{ b.site }}">
            <div class="text-sm font-medium text-ink">{{ b.title }}</div>
            <div class="text-xs text-muted">{{ b.site }}</div>
          </div>
          {% endfor %}
        </div>
        <p class="text-xs text-muted mt-2">Drag onto a lane/time to schedule</p>
      </div>
    </div>

    <!-- Calendar -->
    <div class="lg:col-span-9">
      <div class="bg-white border border-line rounded-2xl p-4 shadow-ft1">
        <div id="calendar" class="rounded-xl overflow-hidden border border-line"></div>
      </div>
    </div>
  </div>
</div>

<!-- Event modal (create / edit) -->
<div id="eventModal" class="ftp-modal fixed inset-0 hidden z-50">
  <div class="absolute inset-0 bg-black/50" data-modal-close="eventModal"></div>
  <div class="absolute inset-0 p-4 flex items-center justify-center">
    <div class="bg-white w-full max-w-xl rounded-2xl border border-line shadow-ft2 overflow-hidden">
      <div class="flex items-center justify-between px-4 py-3 border-b">
        <div class="font-semibold text-ink" id="em_title">Job</div>
        <div class="flex items-center gap-2">
          <button id="em_delete" class="bg-white border border-line rounded-xl px-3 py-1.5 text-red-600">Delete</button>
          <button class="rounded-lg border px-3 py-1.5" data-modal-close="eventModal">Close</button>
        </div>
      </div>
      <div class="p-4 space-y-3">
        <input type="hidden" id="em_id">
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-xs text-muted">Title</label>
            <input id="em_title_input" class="border rounded px-3 py-2 w-full" placeholder="Service @ Site">
          </div>
          <div>
            <label class="text-xs text-muted">Technician</label>
            <select id="em_tech" class="border rounded px-3 py-2 w-full">
              {% for r in RESOURCES %}
              <option value="{{ r.id }}">{{ r.title }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-xs text-muted">Start</label>
            <input id="em_start" type="datetime-local" class="border rounded px-3 py-2 w-full">
          </div>
          <div>
            <label class="text-xs text-muted">End</label>
            <input id="em_end" type="datetime-local" class="border rounded px-3 py-2 w-full">
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-xs text-muted">Status</label>
            <select id="em_status" class="border rounded px-3 py-2 w-full">
              {% for s in STATUS_OPTIONS %}
              <option value="{{ s }}">{{ s }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label class="text-xs text-muted">Site</label>
            <input id="em_site" class="border rounded px-3 py-2 w-full" placeholder="Harbour Tower">
          </div>
        </div>

        <div class="pt-2 flex items-center gap-2">
          <button id="em_save" class="bg-brand text-white rounded-xl px-3 py-2 hover:bg-brand-600">Save</button>
          <button id="em_dup"  class="bg-white border border-line rounded-xl px-3 py-2">Duplicate</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Right-click context menu -->
<div id="ctxMenu" class="fixed z-50 hidden">
  <div class="bg-white border border-line rounded-xl shadow-ft2 min-w-[180px] overflow-hidden">
    <button data-cmd="open"  class="w-full text-left px-3 py-2 hover:bg-panelweak">Open / Edit</button>
    <button data-cmd="dup"   class="w-full text-left px-3 py-2 hover:bg-panelweak">Duplicate</button>
    <button data-cmd="del"   class="w-full text-left px-3 py-2 text-red-600 hover:bg-panelweak">Delete</button>
  </div>
</div>
{% endblock %}

{% block script %}
{{ super() }}
<!-- Scheduler bundle (core + interaction + resource-timegrid + resource-timeline + daygrid) -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar-scheduler/index.global.min.js"></script>
<script src="/assets/firtrackpro/js/portal-demo.js"></script>
<script>
(function(){
  const FC_LICENSE_KEY = {{ FC_LICENSE_KEY | tojson }};
  const RESOURCES = {{ RESOURCES | tojson }};
  const EVENTS    = {{ EVENTS    | tojson }};

  // ---------- helpers ----------
  const fmtLocal = (d)=> new Date(d).toISOString().slice(0,16);
  let currentEvent = null;
  function toast(msg){
    const t=document.createElement('div');
    t.className='fixed top-4 right-4 bg-black/80 text-white text-sm px-3 py-2 rounded-lg z-[60]';
    t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.remove(),1500);
  }

  // ---------- external drag (backlog) ----------
  new FullCalendar.Draggable(document.getElementById('backlog'), {
    itemSelector: '.ext-event',
    eventData: (el)=> ({
      title: el.getAttribute('data-title') || 'Unassigned Task',
      extendedProps: {
        status: el.getAttribute('data-status') || 'Open',
        site: el.getAttribute('data-site') || ''
      }
    })
  });

  // ---------- calendar ----------
  const calEl = document.getElementById('calendar');
  const calendar = new FullCalendar.Calendar(calEl, {
    schedulerLicenseKey: FC_LICENSE_KEY || 'GPL-My-Project-Is-Open-Source',

    // Put the laneway (resources) on the left, time on the right
    initialView: 'resourceTimelineWeek',
    headerToolbar: false,
    nowIndicator: true,

    // Dimensions & scrolling
    height: 780,                  // vertical height; enables vertical scroll for many techs
    stickyHeaderDates: true,
    slotMinTime: '06:00:00',
    slotMaxTime: '20:00:00',
    slotDuration: '00:30:00',
    snapDuration: '00:15:00',
    scrollTime: '08:00:00',
    scrollTimeReset: false,

    // Timeline-specific: make days wide enough + allow horizontal scroll
    dayMinWidth: 180,             // ðŸ‘ˆ key: week stays readable; horizontal scroll kicks in
    slotLabelInterval: { hours: 1 },

    // Work hours & constraints
    businessHours: { daysOfWeek:[1,2,3,4,5], startTime:'07:00', endTime:'17:00' },
    eventConstraint: 'businessHours',

    // Resources (lanes) on the left
    resources: RESOURCES,
    resourceAreaWidth: '18rem',
    resourceGroupField: 'region',
    resourceOrder: 'region,title',
    resourceAreaHeaderContent: 'Technicians',
    resourceAreaColumns: [
      { field: 'title',  headerContent: 'Technician' },
      { field: 'skills', headerContent: 'Skills' }
    ],

    // Data
    events: EVENTS,

    // Interactions
    editable: true,
    eventStartEditable: true,
    eventDurationEditable: true,
    eventResourceEditable: true,

    selectable: true,
    selectMirror: true,

    // External backlog drops
    droppable: true,
    dropAccept: '.ext-event',
    eventReceive(info){
      if(!info.event.id){ info.event.setProp('id', 'JOB-' + Math.floor(1000 + Math.random()*9000)); }
      toast('Scheduled from backlog');
    },

    select(info){
      openModal({
        id: '',
        title: 'Service @ Site',
        start: info.start,
        end: info.end,
        resourceId: info.resource ? info.resource.id : null,
        extendedProps: { status:'Open', site:'', customer:'' }
      }, true);
      calendar.unselect();
    },

    eventDrop:   (i)=> toast(`${i.event.id} moved`),
    eventResize: (i)=> toast(`${i.event.id} resized`),

    // Event decoration & quick actions
    eventDidMount(arg){
      arg.el.addEventListener('contextmenu', (ev)=>{
        ev.preventDefault(); showCtxMenu(ev.pageX, ev.pageY, arg.event);
      });
      arg.el.addEventListener('dblclick', (ev)=>{
        ev.preventDefault(); openModal(arg.event, false);
      });
      const ep = arg.event.extendedProps || {};
      arg.el.title = `${arg.event.title}\n${ep.site || ''} â€¢ ${ep.status || ''}`;
    },
    eventContent(arg){
      const s = (arg.event.extendedProps && arg.event.extendedProps.status) || 'Open';
      const cls = s==='Completed' ? 'badge--ok' : s==='In Progress' ? 'badge--warn' : 'badge--warn';
      const chip = `<span class="text-[10px] px-1.5 py-0.5 rounded-full border mr-1 ${cls}">${s}</span>`;
      return { html: chip + `<span>${arg.event.title}</span>` };
    }
  });

  calendar.render();

  // ---------- toolbar wiring ----------
  document.getElementById('btn_prev').onclick  = ()=>calendar.prev();
  document.getElementById('btn_today').onclick = ()=>calendar.today();
  document.getElementById('btn_next').onclick  = ()=>calendar.next();

  document.querySelectorAll('.viewbtn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const v = btn.getAttribute('data-view');
      calendar.changeView(v);
      if (v.includes('TimeGrid')) { calendar.scrollToTime('08:00:00'); }
    });
  });

  // New button
  document.getElementById('btn_new').addEventListener('click', ()=>{
    const start = new Date(); start.setMinutes(0,0,0); start.setHours(start.getHours()+1);
    const end = new Date(start.getTime()+60*60*1000);
    openModal({
      id: '', title: 'Service @ Site', start, end,
      resourceId: (calendar.getResources()[0]||{}).id,
      extendedProps: { status:'Open', site:'', customer:'' }
    }, true);
  });

  // Status filter (hides events)
  document.getElementById('status_filter').addEventListener('change', (e)=>{
    const s = e.target.value;
    calendar.getEvents().forEach(ev=>{
      const evs = (ev.extendedProps && ev.extendedProps.status) || '';
      ev.setProp('display', (!s || evs === s) ? 'auto' : 'none');
    });
  });

  // ---------- technician (resource) multi-filter ----------
  const techBtn = document.getElementById('tech_filter_btn');
  const techMenu = document.getElementById('tech_filter_menu');
  const techList = document.getElementById('tech_checklist');
  const applyBtn = document.getElementById('tech_filter_apply');
  const clearBtn = document.getElementById('tech_filter_clear');

  function renderTechChecklist() {
    techList.innerHTML = '';
    RESOURCES.forEach(r=>{
      const id = `tech_${r.id}`;
      const row = document.createElement('label');
      row.className = 'flex items-center gap-2 px-1 py-1 rounded hover:bg-panelweak cursor-pointer';
      row.innerHTML = `<input type="checkbox" id="${id}" value="${r.id}" class="accent-[#0f172a]">
                       <span class="text-sm">${r.title}</span>
                       <span class="ml-auto text-xs text-muted">${r.skills||''}</span>`;
      techList.appendChild(row);
    });
  }
  renderTechChecklist();

  techBtn.addEventListener('click', ()=> techMenu.classList.toggle('hidden'));
  document.addEventListener('click', (e)=> {
    if(!e.target.closest('#tech_filter_menu') && !e.target.closest('#tech_filter_btn')){
      techMenu.classList.add('hidden');
    }
  });

  clearBtn.addEventListener('click', ()=>{
    techList.querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked=false);
  });

  applyBtn.addEventListener('click', ()=>{
    const selected = Array.from(techList.querySelectorAll('input[type="checkbox"]:checked')).map(cb=>cb.value);
    // Show only selected resources (rows). If none selected, show all.
    calendar.batchRendering(()=>{
      calendar.getResources().forEach(res=>{
        const show = (selected.length===0) || selected.includes(res.id);
        // hide by toggling a CSS class on the row element
        const rowEl = calendar.el.querySelector(`[data-resource-id="${res.id}"]`);
        if(rowEl){ rowEl.style.display = show ? '' : 'none'; }
      });
    });
    techMenu.classList.add('hidden');
  });

  // ---------- context menu ----------
  const ctx = document.getElementById('ctxMenu');
  let ctxEvt = null;
  function showCtxMenu(x,y,eventApi){ ctxEvt = eventApi; ctx.style.left = x+'px'; ctx.style.top = y+'px'; ctx.classList.remove('hidden'); }
  function hideCtxMenu(){ ctx.classList.add('hidden'); }
  document.addEventListener('click', (e)=>{ if(!e.target.closest('#ctxMenu')) hideCtxMenu(); });
  ctx.addEventListener('click', (e)=>{
    const cmd = e.target.getAttribute('data-cmd'); if(!cmd) return;
    hideCtxMenu(); if(!ctxEvt) return;
    if(cmd==='open'){ openModal(ctxEvt, false); }
    else if(cmd==='dup'){
      const copy = {
        id: ctxEvt.id + '-COPY',
        title: ctxEvt.title,
        start: ctxEvt.start,
        end: ctxEvt.end || new Date(ctxEvt.start.getTime()+60*60*1000),
        resourceId: ctxEvt.getResources()[0]?.id,
        extendedProps: Object.assign({}, ctxEvt.extendedProps)
      };
      calendar.addEvent(copy); toast('Duplicated');
    }else if(cmd==='del'){ ctxEvt.remove(); toast('Deleted'); }
  });

  // ---------- modal ----------
  function openModal(source, isNew){
    const isApi = !!(source && source.setProp);
    currentEvent = isApi ? source : null;
    const ep = (isApi ? source.extendedProps : source.extendedProps) || {};
    document.getElementById('em_id').value = isApi ? source.id : '';
    document.getElementById('em_title').textContent = isApi ? source.id : 'New Job';
    document.getElementById('em_title_input').value = source.title || '';
    document.getElementById('em_tech').value =
      source.resourceId || (isApi && source.getResources()[0]?.id) || (RESOURCES[0] && RESOURCES[0].id) || '';
    document.getElementById('em_start').value = fmtLocal(source.start || (isApi && source.start));
    document.getElementById('em_end').value   = fmtLocal(source.end   || (isApi && source.end) || new Date((source.start || source.startStr || new Date()).getTime() + 60*60*1000));
    document.getElementById('em_status').value = ep.status || 'Open';
    document.getElementById('em_site').value   = ep.site   || '';
    document.getElementById('em_delete').style.display = currentEvent ? '' : 'none';
    FTP.modal.open('eventModal');

    document.getElementById('em_save').onclick = ()=>{
      const v = readForm();
      if(currentEvent){
        currentEvent.setProp('title', v.title);
        currentEvent.setStart(v.start, { maintainDuration: false });
        currentEvent.setEnd(v.end);
        const res = calendar.getResourceById(v.resourceId);
        if(res){
          const payload = {
            id: currentEvent.id, title: v.title,
            start: v.start, end: v.end,
            resourceId: res.id, extendedProps: Object.assign({}, currentEvent.extendedProps)
          };
          currentEvent.remove(); calendar.addEvent(payload);
        }
        const e2 = calendar.getEventById(v.id) || calendar.getEvents().slice(-1)[0];
        e2.setExtendedProp('status', v.status);
        e2.setExtendedProp('site', v.site);
        toast('Saved changes');
      }else{
        calendar.addEvent({
          id: makeId(), title: v.title, start: v.start, end: v.end,
          resourceId: v.resourceId, extendedProps: { status: v.status, site: v.site, customer: '' }
        });
        toast('Created');
      }
      FTP.modal.close('eventModal');
    };

    document.getElementById('em_dup').onclick = ()=>{
      const v = readForm();
      calendar.addEvent({
        id: makeId(), title: v.title, start: v.start, end: v.end,
        resourceId: v.resourceId, extendedProps: { status: v.status, site: v.site, customer: '' }
      });
      toast('Duplicated'); FTP.modal.close('eventModal');
    };

    document.getElementById('em_delete').onclick = ()=>{
      if(currentEvent){ currentEvent.remove(); toast('Deleted'); }
      FTP.modal.close('eventModal');
    };
  }

  function readForm(){
    return {
      id: document.getElementById('em_id').value,
      title: document.getElementById('em_title_input').value || 'Service @ Site',
      resourceId: document.getElementById('em_tech').value,
      start: new Date(document.getElementById('em_start').value),
      end:   new Date(document.getElementById('em_end').value),
      status: document.getElementById('em_status').value,
      site:   document.getElementById('em_site').value
    };
  }
  function makeId(){ return 'JOB-' + Math.floor(1000 + Math.random()*9000); }
})();
</script>
{% endblock %}
