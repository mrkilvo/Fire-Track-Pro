{# Template-only menu source of truth.
   This macro BUILDS the MENU and immediately calls the sidebar renderer.
   No JSON, no Python menu structures needed. #}

{% macro render_with_sidebar(SB, user_roles) -%}
  {# ----- Role groups (edit to match your site's Roles) ----- #}
  {% set ROLE = {
    "admin": ["Administrator","System Manager"],
    "office": ["Administrator","System Manager","Projects Manager","Sales Manager","Sales User","Support Team","Purchase User","Stock User","Accounts User","Accounts Manager","Website Manager"],
    "field": ["Administrator","Technician","Field User","Maintenance User"],
    "billing": ["Administrator","Accounts User","Accounts Manager","System Manager"],
    "reports": ["Report Manager","System Manager","Analytics"],
    "people": ["Sales User","CRM User","Support Team","System Manager"],
    "sites": ["Projects User","Sales User","System Manager"],
    "assets": ["Maintenance User","Stock User","System Manager"],
    "documents": ["Website Manager","System Manager","Sales User","Support Team"],
    "quotes": ["Sales User","Sales Manager","System Manager"],
    "inspections": ["Quality Manager","Maintenance User","System Manager"],
    "incidents": ["Support Team","System Manager"],
    "suppliers": ["Purchase User","Buying User","Stock User","System Manager"],
    "tools": ["System Manager"],
    "configuration": ["System Manager"],
    "forms": ["Website Manager","System Manager"],
    "accounts_admin": ["Administrator","System Manager"],
    "accounts_security": ["Administrator","System Manager"],
    "accounts_email": ["System Manager","Support Team"],
    "settings": ["System Manager"],
    "help": []
  } %}

  {# ----- MENU definition (3+ levels supported) ----- #}
  {% set MENU = [
    {"label":"Dashboard","icon":"home","url":"/portal","roles":["*"]},

    {"label":"Work","icon":"briefcase","roles": ROLE.office + ROLE.field + ROLE.admin,"children":[
      {"label":"Scheduler","icon":"calendar","url":"/portal/scheduler","roles": ROLE.office + ROLE.field},
      {"label":"Tasks","icon":"list","url":"/portal/tasks","roles": ROLE.office + ROLE.field},
      {"label":"Defect Quotes","icon":"file-text","url":"/portal/defect-quotes","roles": ROLE.quotes},
      {"label":"Inspections","icon":"clipboard","url":"/portal/inspections","roles": ROLE.inspections},
      {"label":"Incidents","icon":"alert-circle","url":"/portal/incidents","roles": ROLE.incidents},
      {"label":"Quotes","icon":"file-plus","url":"/portal/quotes","roles": ROLE.quotes}
    ]},

    {"label":"Sites & Assets","icon":"map","roles": ROLE.sites + ROLE.assets + ROLE.admin,"children":[
      {"label":"Sites","icon":"map","url":"/portal/sites","roles": ROLE.sites},
      {"label":"Assets","icon":"box","url":"/portal/assets","roles": ROLE.assets},
      {"label":"Documents","icon":"file","url":"/portal/documents","roles": ROLE.documents}
    ]},

    {"label":"People","icon":"users","roles": ROLE.people + ROLE.admin,"children":[
      {"label":"Customer Data","icon":"database","url":"/portal/customers","roles": ROLE.people},
      {"label":"Suppliers","icon":"truck","url":"/portal/suppliers","roles": ROLE.suppliers}
    ]},

    {"label":"Billing","icon":"dollar-sign","roles": ROLE.billing,"children":[
      {"label":"Invoices","icon":"file","url":"/portal/invoices","roles": ROLE.billing},
      {"label":"Purchase Orders","icon":"file","url":"/portal/purchase-orders","roles": ROLE.billing}
    ]},

    {"label":"Reports","icon":"bar-chart-2","url":"/portal/reports","roles": ROLE.reports + ROLE.admin},

    {"label":"Admin","icon":"settings","roles": ROLE.admin,"children":[
      {"label":"Tools","icon":"tool","url":"/portal/tools","roles": ROLE.tools},
      {"label":"Configuration","icon":"settings","url":"/portal/configuration","roles": ROLE.configuration},
      {"label":"Custom Forms","icon":"edit","url":"/portal/forms","roles": ROLE.forms},

      {"label":"Accounts","icon":"user","roles": ROLE.accounts_admin,"children":[
        {"label":"Users","icon":"user","roles": ROLE.accounts_admin,"children":[
          {"label":"Dashboard","url":"/portal/accounts/dashboard","roles": ROLE.accounts_admin},
          {"label":"Create User","url":"/portal/accounts/create","roles": ROLE.accounts_admin}
        ]},
        {"label":"Security","icon":"shield","roles": ROLE.accounts_security,"children":[
          {"label":"Audit Log","url":"/portal/accounts/accesslog","roles": ROLE.accounts_security},
          {"label":"Assume Identity","url":"/portal/accounts/assumeidentity","roles": ROLE.accounts_security}
        ]},
        {"label":"Email","icon":"mail","roles": ROLE.accounts_email,"children":[
          {"label":"Send Welcome Email","url":"/portal/accounts/sendwelcomeemail","roles": ROLE.accounts_email}
        ]}
      ]},

      {"label":"Settings","icon":"sliders","url":"/portal/settings","roles": ROLE.settings},
      {"label":"Help","icon":"help-circle","url":"/portal/help","roles": ROLE.help}
    ]}
  ] %}

  {{ SB.render_sidebar(MENU, user_roles) }}
{%- endmacro %}
