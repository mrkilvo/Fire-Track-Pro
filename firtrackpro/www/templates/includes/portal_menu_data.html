{# Template-only menu source of truth.
   Builds ROLE + MENU and calls the sidebar renderer macro. #}

{% macro render_with_sidebar(SB, user_roles) -%}

  {# ---- Base role sets ---- #}
  {% set ROLE = {
    "admin": ["Administrator","System Manager"],
    "office": ["Projects Manager","Sales Manager","Sales User","Support Team","Website Manager","System Manager"],
    "field": ["Technician","Field User","Maintenance User"],
    "billing": ["Accounts User","Accounts Manager","System Manager"],
    "inventory": ["Stock User","Purchase User","System Manager"],
    "reports": ["Report Manager","Analytics","System Manager"],
    "people": ["CRM User","Sales User","Support Team","System Manager"],
    "compliance": ["Quality Manager","Maintenance User","System Manager"],
    "safety": ["Technician","Maintenance User","System Manager"],
    "fleet": ["System Manager","Maintenance User"],
    "firelink": ["System Manager"]
  } %}

  {# ---- Combined groups (avoid + inside dicts) ---- #}
  {% set R_WORK_ALL = ROLE.office + ROLE.field + ROLE.admin %}
  {% set R_OFFICE_ADMIN = ROLE.office + ROLE.admin %}
  {% set R_PEOPLE_ADMIN = ROLE.people + ROLE.admin %}
  {% set R_BILL_ADMIN = ROLE.billing + ROLE.admin %}
  {% set R_REPORTS_ADMIN = ROLE.reports + ROLE.admin %}
  {% set R_FLEET_ADMIN = ROLE.fleet + ROLE.admin %}
  {% set R_COMPLIANCE_ADMIN = ROLE.compliance + ROLE.admin %}
  {% set R_SAFETY_ADMIN = ROLE.safety + ROLE.admin %}
  {% set R_INVENTORY_ADMIN = ROLE.inventory + ROLE.admin %}

  {# ---- MENU definition ---- #}
  {% set MENU = [
    {"label":"Dashboard","icon":"home","url":"/portal","roles":["*"]},

    {"label":"Work","icon":"briefcase","roles": R_WORK_ALL, "children":[
      {"label":"Scheduler","icon":"calendar","url":"/portal/scheduler","roles": R_OFFICE_ADMIN},
      {"label":"Jobs","icon":"list","url":"/portal/jobs","roles": R_WORK_ALL},
      {"label":"Defects","icon":"alert-circle","url":"/portal/defects","roles": R_WORK_ALL},
      {"label":"Repairs","icon":"tool","url":"/portal/repairs","roles": R_WORK_ALL},
      {"label":"Quotes","icon":"file-plus","url":"/portal/quotes","roles": ["Sales User","Sales Manager","System Manager"]}
    ]},

    {"label":"Sites & Assets","icon":"map","roles": R_WORK_ALL, "children":[
      {"label":"Properties","icon":"map","url":"/portal/sites","roles": R_WORK_ALL},
      {"label":"Assets","icon":"box","url":"/portal/assets","roles": R_WORK_ALL},
      {"label":"Zones","icon":"map","url":"/portal/zones","roles": R_OFFICE_ADMIN},
      {"label":"Document Vault","icon":"file-text","url":"/portal/documents","roles": R_OFFICE_ADMIN},
      {"label":"Pump Profiles","icon":"settings","url":"/portal/pump-profiles","roles": R_WORK_ALL},
      {"label":"Flow Tests","icon":"bar-chart-2","url":"/portal/flow-tests","roles": R_WORK_ALL}
    ]},

    {"label":"Compliance","icon":"shield","roles": R_COMPLIANCE_ADMIN, "children":[
      {"label":"ESM Register (VIC)","icon":"clipboard","url":"/portal/esm","roles": R_COMPLIANCE_ADMIN},
      {"label":"AFSS Certificates (NSW)","icon":"file","url":"/portal/afss","roles": R_COMPLIANCE_ADMIN},
      {"label":"Notifications","icon":"mail","url":"/portal/notifications","roles": R_COMPLIANCE_ADMIN}
    ]},

    {"label":"Safety","icon":"help-circle","roles": R_SAFETY_ADMIN, "children":[
      {"label":"JSA","icon":"clipboard","url":"/portal/jsa","roles": R_SAFETY_ADMIN},
      {"label":"SWMS","icon":"file-text","url":"/portal/swms","roles": R_SAFETY_ADMIN},
      {"label":"Permits to Work","icon":"edit","url":"/portal/permits","roles": R_SAFETY_ADMIN},
      {"label":"Toolbox Talks","icon":"users","url":"/portal/toolbox","roles": R_SAFETY_ADMIN},
      {"label":"Incidents & CAPA","icon":"alert-circle","url":"/portal/incidents","roles": R_SAFETY_ADMIN}
    ]},

    {"label":"Instruments","icon":"settings","roles": R_INVENTORY_ADMIN, "children":[
      {"label":"Instruments","icon":"settings","url":"/portal/instruments","roles": R_INVENTORY_ADMIN},
      {"label":"Calibrations","icon":"settings","url":"/portal/instrument-calibrations","roles": R_INVENTORY_ADMIN},
      {"label":"Bookings","icon":"calendar","url":"/portal/instrument-bookings","roles": R_INVENTORY_ADMIN}
    ]},

    {"label":"People","icon":"users","roles": R_PEOPLE_ADMIN, "children":[
      {"label":"Customers","icon":"database","url":"/portal/customers","roles": R_PEOPLE_ADMIN},
      {"label":"Suppliers","icon":"truck","url":"/portal/suppliers","roles": ["Purchase User","Stock User","System Manager"]},
      {"label":"Technicians","icon":"user","url":"/portal/technicians","roles": R_OFFICE_ADMIN}
    ]},

    {"label":"Billing","icon":"dollar-sign","roles": R_BILL_ADMIN, "children":[
      {"label":"Invoices","icon":"file","url":"/portal/invoices","roles": R_BILL_ADMIN},
      {"label":"Purchase Orders","icon":"file","url":"/portal/purchase-orders","roles": ["Purchase User","Accounts Manager","System Manager"]}
    ]},

    {"label":"Reporting","icon":"bar-chart-2","roles": R_REPORTS_ADMIN, "children":[
      {"label":"Report Packages","icon":"file-text","url":"/portal/report-packages","roles": R_REPORTS_ADMIN},
      {"label":"Drafts","icon":"edit","url":"/portal/report-drafts","roles": R_REPORTS_ADMIN},
      {"label":"Publications","icon":"file-text","url":"/portal/report-publications","roles": R_REPORTS_ADMIN},
      {"label":"Document Vault","icon":"file","url":"/portal/documents","roles": R_REPORTS_ADMIN}
    ]},

    {"label":"Workforce & Fleet","icon":"truck","roles": R_FLEET_ADMIN, "children":[
      {"label":"Timesheets","icon":"list","url":"/portal/timesheets","roles": R_WORK_ALL},
      {"label":"Job Events (GPS)","icon":"map","url":"/portal/job-events","roles": R_OFFICE_ADMIN},
      {"label":"Vehicles","icon":"truck","url":"/portal/vehicles","roles": R_FLEET_ADMIN},
      {"label":"Vehicle Logs","icon":"file-text","url":"/portal/vehicle-logs","roles": R_FLEET_ADMIN}
    ]},

    {"label":"Admin","icon":"settings","roles": ROLE.admin, "children":[
      {"label":"FT Settings","icon":"settings","url":"/portal/settings","roles": ROLE.admin},
      {"label":"SLA Policies","icon":"sliders","url":"/portal/sla-policies","roles": ROLE.admin},
      {"label":"Work Calendar","icon":"calendar","url":"/portal/work-calendar","roles": ROLE.admin},
      {"label":"Audit Log","icon":"shield","url":"/portal/audit-log","roles": ROLE.admin},
      {"label":"QC Review","icon":"edit","url":"/portal/qc-review","roles": ROLE.admin},
      {"label":"FireLink Consent","icon":"settings","url":"/portal/firelink-consent","roles": ROLE.firelink},
      {"label":"Email","icon":"mail","url":"/portal/emails","roles": ["System Manager","Support Team"]}
    ]}
  ] %}

  {{ SB.render_sidebar(MENU, user_roles) }}

{%- endmacro %}
