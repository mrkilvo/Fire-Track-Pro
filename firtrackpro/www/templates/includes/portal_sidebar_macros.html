{# Font Awesome icon map #}
{% set ICON = {
  "home": "fa-solid fa-gauge-high",
  "briefcase": "fa-solid fa-briefcase",
  "calendar": "fa-solid fa-calendar-days",
  "list": "fa-solid fa-list-check",
  "file-text": "fa-solid fa-file-lines",
  "clipboard": "fa-solid fa-clipboard-list",
  "alert-circle": "fa-solid fa-triangle-exclamation",
  "file-plus": "fa-solid fa-file-circle-plus",
  "map": "fa-solid fa-map",
  "box": "fa-solid fa-box-archive",
  "file": "fa-solid fa-file",
  "users": "fa-solid fa-users",
  "database": "fa-solid fa-database",
  "truck": "fa-solid fa-truck",
  "dollar-sign": "fa-solid fa-dollar-sign",
  "bar-chart-2": "fa-solid fa-chart-column",
  "settings": "fa-solid fa-gear",
  "tool": "fa-solid fa-screwdriver-wrench",
  "edit": "fa-solid fa-pen-to-square",
  "user": "fa-solid fa-user",
  "shield": "fa-solid fa-shield-halved",
  "mail": "fa-solid fa-envelope",
  "sliders": "fa-solid fa-sliders",
  "help-circle": "fa-solid fa-circle-question"
} %}

{% macro _icon(name) -%}
  <i class="sb-icon {{ ICON.get(name, 'fa-solid fa-circle') }}"></i>
{%- endmacro %}

{# RBAC check #}
{% macro _allowed(item, user_roles) -%}
  {%- set roles = item.roles or [] -%}
  {%- if roles|length == 0 -%}
    {{ True }}
  {%- else -%}
    {%- set ns = namespace(ok=False) -%}
    {%- for r in roles -%}
      {%- set rr = (r or '')|trim|lower -%}
      {%- if rr == '*' -%}
        {%- set ns.ok = True -%}
      {%- else -%}
        {%- for ur in user_roles or [] -%}
          {%- if (ur or '')|trim|lower == rr -%}
            {%- set ns.ok = True -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endif -%}
    {%- endfor -%}
    {{ ns.ok }}
  {%- endif -%}
{%- endmacro %}

{# Recursive Flowbite accordion renderer #}
{% macro recursive_flowbite(items, user_roles, path="root") -%}
  {%- for item in items or [] -%}
    {%- set has_children = item.children is defined and item.children -%}
    {%- set allowed_self = (_allowed(item, user_roles)|string) == 'True' -%}

    {# collect allowed children #}
    {%- set vc = namespace(list=[]) -%}
    {%- if has_children -%}
      {%- for c in item.children -%}
        {%- if (_allowed(c, user_roles)|string) == 'True' -%}
          {%- set vc.list = vc.list + [c] -%}
        {%- endif -%}
      {%- endfor -%}
    {%- endif -%}

    {# slug/id helpers (no regex to stay portable) #}
    {%- set base = (item.label|lower|replace(' ','-')|replace('&','and')|replace('/','-')|replace('.','-')|replace('#','-')) -%}
    {%- set sid = (path ~ '-' ~ base ~ '-' ~ loop.index0)|replace('--','-') -%}
    {%- set hid = 'acc-h-' ~ sid -%}
    {%- set bid = 'acc-b-' ~ sid -%}

    {%- if has_children -%}
      {%- if allowed_self or vc.list|length > 0 -%}
        <h2 id="{{ hid }}">
          <button type="button"
                  class="w-full flex items-center gap-3 px-3 py-2.5 mt-1 rounded-lg hover:bg-white/10 text-white"
                  data-accordion-target="#{{ bid }}"
                  aria-expanded="false"
                  aria-controls="{{ bid }}">
            {{ _icon(item.icon) }}
            <span class="truncate">{{ item.label }}</span>
            <svg data-accordion-icon class="sb-chevron ml-auto w-4 h-4 text-white/80" aria-hidden="true"
                 xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6">
              <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 5 5 1 1 5"/>
            </svg>
          </button>
        </h2>
        <div id="{{ bid }}" class="hidden" aria-labelledby="{{ hid }}">
          {% if vc.list|length > 0 %}
          <div class="my-2 pl-3 border-l border-white/10"
               data-accordion="collapse"
               data-active-classes="bg-white/10 text-white"
               data-inactive-classes="text-slate-300">
            {{ recursive_flowbite(vc.list, user_roles, sid) }}
          </div>
          {% endif %}
        </div>
      {%- endif -%}
    {%- else -%}
      {%- if allowed_self -%}
        <a href="{{ item.url or '#' }}"
           class="flex items-center gap-3 px-3 py-2.5 mt-1 rounded-lg text-slate-300 hover:bg-white/10 hover:text-white">
          {{ _icon(item.icon) }}
          <span class="truncate">{{ item.label }}</span>
        </a>
      {%- endif -%}
    {%- endif -%}
  {%- endfor -%}
{%- endmacro %}

{% macro render_sidebar(menu, user_roles) -%}
  <aside id="sidebar" class="w-64 min-h-screen sticky top-0 bg-[var(--sidebar-bg)] text-[var(--sidebar-text)]">
    <div class="px-4 py-5 border-b border-white/10">
      <div class="flex items-center gap-3">
        <img src="/assets/firtrackpro/images/firetrack-logo.png"
             alt="Fire Track Pro"
             class="w-5 h-5 object-contain select-none shrink-0"
             draggable="false">
        <div class="leading-tight">
          <div class="text-white font-semibold">Fire Track Pro</div>
          <div class="text-xs text-white/70">Navigation</div>
        </div>
      </div>
    </div>

    <nav class="p-3 text-sm text-white">
      <p class="px-2 py-2 text-xs uppercase tracking-wider text-white/60">Main</p>
      <div id="portal-accordion"
           data-accordion="collapse"
           data-active-classes="bg-white/10 text-white"
           data-inactive-classes="text-slate-300">
        {{ recursive_flowbite(menu, user_roles, "root") }}
      </div>
    </nav>

    <div class="mt-4 px-3 py-3 border-t border-white/10 text-xs text-white/70">
      Â© <span id="year"></span> Fire Track Pro 
    </div>
  </aside>
{%- endmacro %}
