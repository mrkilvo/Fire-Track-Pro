{% extends "firtrackpro/www/templates/base_brand.html" %}
{% block title %}Portal{% endblock %}
{% block navbar %}{% endblock %}

{% block head_include %}
  {{ super() }}
  {# Use compiled Tailwind in production (prebuilt via bench build) #}
 <link rel="stylesheet" href="/assets/firtrackpro/css/portal.tailwind.css">
<link rel="stylesheet" href="/assets/firtrackpro/css/custom.css">
<script defer src="/assets/firtrackpro/js/flowbite.min.js"></script>
  <style>
    :root{
      --sidebar-bg:#161616;
      --sidebar-text:#ffffff;
      --brand-accent:#e11d48;
      --brand-accent-600:#be123c;

      /* ========= SCALING CONTROLS ========= */
      --topbar-scale:1.45;                 /* 25% size â€” tweak per page if needed */
      --topbar-base-height:40px;
      --topbar-base-icon:14px;
      --topbar-base-avatar:24px;
      --topbar-base-title:13px;
      --topbar-base-gap:0.375rem;
      --topbar-base-xpad:0.5rem;

      /* Derived sizes (auto-scale) */
      --topbar-height:calc(var(--topbar-base-height)*var(--topbar-scale));
      --topbar-icon-size:calc(var(--topbar-base-icon)*var(--topbar-scale));
      --topbar-avatar-size:calc(var(--topbar-base-avatar)*var(--topbar-scale));
      --topbar-title-size:calc(var(--topbar-base-title)*var(--topbar-scale));
      --topbar-gap:calc(var(--topbar-base-gap)*var(--topbar-scale));
      --topbar-xpad:calc(var(--topbar-base-xpad)*var(--topbar-scale));
      --topbar-button-size:calc(var(--topbar-height) - 2px);
    }
    /* Sidebar icon sizes (kept from earlier) */
    --sidebar-icon-size:22px;
    --sidebar-chevron-size:18px;
    .sb-icon{font-size:var(--sidebar-icon-size);width:1.6em;height:1.6em;display:inline-flex;align-items:center;justify-content:center;line-height:1}
    .sb-chevron{font-size:var(--sidebar-chevron-size);line-height:1}

    /* Top bar */
    .tb{height:var(--topbar-height)}
    .tb-wrap{padding-left:var(--topbar-xpad);padding-right:var(--topbar-xpad)}
    .tb-title{font-size:var(--topbar-title-size);line-height:1;margin:0}
    .tb-icon{font-size:var(--topbar-icon-size);line-height:1}
    .tb-avatar{height:var(--topbar-avatar-size);width:var(--topbar-avatar-size)}
    .tb-btn{width:var(--topbar-button-size);height:var(--topbar-button-size)}
    .tb-name{font-size:max(10px, calc(var(--topbar-title-size)*0.92))}
  </style>
{% endblock %}

{% block page_content %}
<div class="min-h-screen flex bg-gray-50">

  {# Sidebar (template-driven RBAC) #}
  {% import "firtrackpro/www/templates/includes/portal_menu_data.html" as DATA %}
  {% import "firtrackpro/www/templates/includes/portal_sidebar_macros.html" as SB %}
  {{ DATA.render_with_sidebar(SB, user_roles or []) }}

  <main class="flex-1">

    {# ===== Compact Top Bar (flush-left beside sidebar) ===== #}
    <header class="sticky top-0 z-10 bg-white/90 backdrop-blur border-b border-gray-200">
      <div class="tb tb-wrap w-full flex items-center justify-between">
        <div class="min-w-0 flex items-center">
          <h1 class="tb-title font-semibold text-slate-900 truncate">
            {{ page_h1 or "Untitled" }}
          </h1>
        </div>
        <div class="flex items-center" style="gap:var(--topbar-gap);">
          <a href="{{ portal_messages_url or '/portal/messages' }}"
             class="tb-btn inline-flex items-center justify-center rounded-full hover:bg-gray-100 focus:bg-gray-100"
             title="Messages" aria-label="Messages">
            <i class="fa-regular fa-envelope tb-icon text-slate-700"></i>
          </a>
          <a href="{{ portal_notifications_url or '#' }}"
             class="tb-btn inline-flex items-center justify-center rounded-full hover:bg-gray-100 focus:bg-gray-100"
             title="Notifications" aria-label="Notifications">
            <i class="fa-regular fa-bell tb-icon text-slate-700"></i>
          </a>
          <div class="flex items-center" style="gap:calc(var(--topbar-gap)*0.8);">
            <img src="{{ user_avatar_url or '/assets/frappe/images/avatar.svg' }}"
                 alt="User avatar"
                 class="tb-avatar rounded-full object-cover border border-gray-200"
                 loading="lazy"
                 onerror="this.onerror=null;this.src='/assets/frappe/images/avatar.svg';">
            <span class="tb-name text-slate-800 font-medium truncate max-w-[150px]">
              {{ user_full_name or 'User' }}
            </span>
          </div>
        </div>
      </div>
    </header>

    {# ==== PAGE BODY SLOT (override in child pages) ==== #}
    {% block portal_content %}{% endblock %}

  </main>
</div>
{% endblock %}

{% block script %}
  {{ super() }}

  {# Mixed-content safety: upgrade same-host http -> https for media/links #}
  <script>
  (function(){
    function toHttps(u){
      try{
        const url = new URL(u, window.location.origin);
        if(url.hostname === window.location.hostname && url.protocol === 'http:'){ url.protocol = 'https:'; }
        return url.href;
      }catch(_){ return u; }
    }
    function fix(container){
      container.querySelectorAll('img[src],a[href],source[src],video[src],audio[src]').forEach(el=>{
        const attr = el.hasAttribute('href') ? 'href' : 'src';
        const v = el.getAttribute(attr);
        if(!v) return;
        const nv = toHttps(v);
        if(nv !== v) el.setAttribute(attr, nv);
      });
    }
    if(document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', ()=>fix(document)); }
    else { fix(document); }
  })();
  </script>

  {# Quiet highlight.js deprecation from Frappe's website.js #}
  <script>
  window.hljs = window.hljs || {};
  if(typeof window.hljs.initHighlighting === 'function'){
    try{ window.hljs.highlightAll && window.hljs.highlightAll(); }catch(_){}
    window.hljs.initHighlighting = function(){ /* suppressed */ };
  }
  </script>

  {# Sidebar accordion toggle #}
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      const sidebar=document.getElementById('sidebar');
      if(!sidebar) return;
      sidebar.addEventListener('click',function(e){
        const btn=e.target.closest('[data-toggle]');
        if(!btn||!sidebar.contains(btn)) return;
        e.preventDefault();
        const panel=btn.nextElementSibling;
        if(!panel||!panel.classList.contains('submenu')) return;
        const isOpen=!panel.classList.contains('hidden');
        panel.classList.toggle('hidden');
        const chev=btn.querySelector('[data-chevron]');
        if(chev) chev.style.transform=isOpen?'rotate(0deg)':'rotate(180deg)';
      });
    });
  </script>
{% endblock %}
