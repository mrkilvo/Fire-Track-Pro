{% extends "firtrackpro/www/templates/base_template.html" %}
{% set hide_base_footer = True %}
{% block navbar %}{% endblock %}

{% set MENU = [
  {"label":"Dashboard","icon":"home","url":"/portal"},
  {"label":"Scheduler","icon":"calendar","url":"/portal/scheduler"},
  {"label":"Tasks","icon":"list","url":"/portal/tasks"},
  {"label":"Defect Quotes","icon":"file-text","url":"/portal/defect-quotes"},
  {"label":"People","icon":"users","url":"/portal/people"},
  {"label":"Billing","icon":"dollar-sign","url":"#","children":[
    {"label":"Invoices","url":"/portal/invoices"},
    {"label":"Purchase Orders","url":"/portal/purchase-orders"}
  ]},
  {"label":"Customer Data","icon":"database","url":"/portal/customers"},
  {"label":"Tools","icon":"tool","url":"/portal/tools"},
  {"label":"Assets","icon":"box","url":"/portal/assets"},
  {"label":"Sites","icon":"map","url":"/portal/sites"},
  {"label":"Documents","icon":"file","url":"/portal/documents"},
  {"label":"Reports","icon":"bar-chart-2","url":"/portal/reports"},
  {"label":"Inspections","icon":"clipboard","url":"/portal/inspections"},
  {"label":"Incidents","icon":"alert-circle","url":"/portal/incidents"},
  {"label":"Suppliers","icon":"truck","url":"/portal/suppliers"},
  {"label":"Quotes","icon":"file-plus","url":"/portal/quotes"},
  {"label":"Contracts","icon":"file","url":"/portal/contracts"},
  {"label":"Settings","icon":"settings","url":"/portal/settings"},
  {"label":"Help","icon":"help-circle","url":"/portal/help"},
  {"label":"Accounts","icon":"user","url":"#","children":[
    {"label":"Dashboard","url":"/portal/accounts/dashboard"},
    {"label":"Create User","url":"/portal/accounts/create"},
    {"label":"Audit Log","url":"/portal/accounts/accesslog"},
    {"label":"Send Welcome Email","url":"/portal/accounts/sendwelcomeemail"},
    {"label":"Assume Identity","url":"/portal/accounts/assumeidentity"}
  ]},
  {"label":"Configuration","icon":"settings","url":"/portal/configuration"},
  {"label":"Custom Forms","icon":"edit","url":"/portal/forms"}
] %}

{# block content = chrome (menu + layout) #}
{% block content %}
<div id="portal-root" class="min-h-screen flex flex-row bg-gray-50 font-sans">

  <!-- DESKTOP SIDEBAR: always visible (no hidden/md gate) -->
  <nav id="sidebar-desktop"
       class="flex flex-col w-64 bg-gray-900 text-white px-4 py-6 space-y-1 shadow-lg z-10"
       style="display:flex">
    <div class="flex items-center gap-2 mb-8">
      <img src="/assets/firtrackpro/images/firetrack-logo.png" class="w-10 h-10 rounded bg-white" alt="Logo">
      <span class="text-2xl font-bold tracking-wide text-white">Fire Track Pro</span>
    </div>

    {% for item in MENU %}
      {% if item.children %}
        <div class="submenu-group">
          <button type="button"
                  class="submenu-toggle flex items-center gap-2 px-3 py-2 rounded-lg w-full text-white hover:bg-gray-700 font-semibold">
            <i data-feather="{{ item.icon }}"></i><span>{{ item.label }}</span>
            <svg class="ml-auto w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/>
            </svg>
          </button>
          <div class="submenu hidden flex-col space-y-1 pl-6 transition-all duration-300 ease-in-out opacity-0 max-h-0 overflow-hidden">
            {% for sub in item.children %}
              <a href="{{ sub.url }}" class="sidebar-link flex items-center gap-2 px-3 py-2 rounded-lg text-gray-300 hover:bg-gray-600 text-sm">
                <span>{{ sub.label }}</span>
              </a>
            {% endfor %}
          </div>
        </div>
      {% else %}
        <a href="{{ item.url }}" class="sidebar-link flex items-center gap-2 px-3 py-2 rounded-lg text-white hover:bg-gray-700">
          <i data-feather="{{ item.icon }}"></i><span>{{ item.label }}</span>
        </a>
      {% endif %}
    {% endfor %}
  </nav>

  <!-- MOBILE SIDEBAR (only on small screens) -->
  <div id="mobile-sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-40 z-40 hidden md:hidden"></div>

  <nav id="mobile-sidebar"
       class="fixed left-0 top-14 bottom-0 w-64 bg-gray-900 text-white z-50 transform -translate-x-full transition-transform duration-300 flex md:hidden flex-col px-4 py-6 space-y-1 shadow-lg overflow-y-auto"
       style="height:calc(100vh - 56px);">
    <div class="flex items-center gap-2 mb-8">
      <img src="/assets/firtrackpro/images/firetrack-logo.png" class="w-10 h-10 rounded bg-white" alt="Logo">
      <span class="text-2xl font-bold tracking-wide text-white">Fire Track Pro</span>
      <button id="mobile-menu-close" class="ml-auto p-2" type="button">
        <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    {% for item in MENU %}
      {% if item.children %}
        <div class="submenu-group">
          <button type="button" class="submenu-toggle flex items-center gap-2 px-3 py-2 rounded-lg w-full text-white hover:bg-gray-700 font-semibold">
            <i data-feather="{{ item.icon }}"></i><span>{{ item.label }}</span>
            <svg class="ml-auto w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/>
            </svg>
          </button>
          <div class="submenu hidden flex-col space-y-1 pl-6 transition-all duration-300 ease-in-out opacity-0 max-h-0 overflow-hidden">
            {% for sub in item.children %}
              <a href="{{ sub.url }}" class="sidebar-link flex items-center gap-2 px-3 py-2 rounded-lg text-gray-300 hover:bg-gray-600 text-sm">
                <span>{{ sub.label }}</span>
              </a>
            {% endfor %}
          </div>
        </div>
      {% else %}
        <a href="{{ item.url }}" class="sidebar-link flex items-center gap-2 px-3 py-2 rounded-lg text-white hover:bg-gray-700">
          <i data-feather="{{ item.icon }}"></i><span>{{ item.label }}</span>
        </a>
      {% endif %}
    {% endfor %}
  </nav>

  <!-- MAIN COLUMN: page content -->
  <main class="flex-1 flex flex-col w-full min-h-screen">
    <div class="sticky top-0 z-50 w-full bg-white border-b shadow-sm h-14 flex items-center justify-between px-4 md:px-6">
      <div class="flex items-center gap-3 h-full">
        <button id="mobile-menu-btn" class="p-2 -ml-2 md:hidden" type="button">
          <svg class="w-7 h-7 text-gray-700" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/>
          </svg>
        </button>
        <span id="topbar-title" class="text-xl font-semibold text-gray-800">Dashboard</span>
      </div>
      <div class="flex items-center gap-4">
        <button class="p-2 rounded hover:bg-gray-100"><i data-feather="bell"></i></button>
        <button class="p-2 rounded hover:bg-gray-100"><i data-feather="message-square"></i></button>
        <a href="/portal/accounts/profile" class="flex items-center gap-2 group">
          <span class="font-medium text-gray-700 group-hover:underline">{{ full_name or "Steve Kilvington" }}</span>
          <div class="w-9 h-9 bg-gray-200 rounded-full flex items-center justify-center font-bold text-gray-800">SK</div>
        </a>
      </div>
    </div>

    {% block page_content %}{% endblock %}
  </main>
</div>
{% endblock %}

{% block footer %}{% endblock %}

{% block script %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded',function(){
  if(window.feather) feather.replace();

  const path = window.location.pathname.replace(/\/$/,"");

  // Submenus
  document.querySelectorAll('.submenu-group').forEach(function(group){
    const btn = group.querySelector('.submenu-toggle');
    const submenu = group.querySelector('.submenu');
    let active = false;

    group.querySelectorAll('a.sidebar-link').forEach(function(a){
      if ((a.getAttribute('href')||'').replace(/\/$/,'') === path) {
        a.classList.add('bg-gray-600','text-white'); active = true;
      }
    });

    if (active && submenu && btn) {
      submenu.classList.remove('hidden','opacity-0','max-h-0');
      submenu.classList.add('opacity-100','max-h-96');
      btn.classList.add('bg-gray-800','text-white');
    }

    if (btn && submenu) {
      btn.addEventListener('click', function(){
        const open = !submenu.classList.contains('hidden');
        if (open) {
          submenu.classList.add('opacity-0','max-h-0');
          submenu.classList.remove('opacity-100','max-h-96');
          setTimeout(()=>submenu.classList.add('hidden'),300);
        } else {
          submenu.classList.remove('hidden');
          requestAnimationFrame(()=>{
            submenu.classList.remove('opacity-0','max-h-0');
            submenu.classList.add('opacity-100','max-h-96');
          });
        }
      });
    }
  });

  // highlight direct links
  document.querySelectorAll('a.sidebar-link').forEach(function(a){
    if ((a.getAttribute('href')||'').replace(/\/$/,'') === path) {
      a.classList.add('bg-gray-700','text-white');
    }
  });

  // mobile drawer
  const openBtn = document.getElementById('mobile-menu-btn');
  const closeBtn = document.getElementById('mobile-menu-close');
  const sidebar  = document.getElementById('mobile-sidebar');
  const overlay  = document.getElementById('mobile-sidebar-overlay');
  function openSidebar(){ sidebar.classList.remove('-translate-x-full'); overlay.classList.remove('hidden'); }
  function closeSidebar(){ sidebar.classList.add('-translate-x-full'); overlay.classList.add('hidden'); }
  if (openBtn) openBtn.onclick = openSidebar;
  if (closeBtn) closeBtn.onclick = closeSidebar;
  if (overlay) overlay.onclick = closeSidebar;

  // title
  const tt=document.getElementById('topbar-title');
  if (tt) {
    const active = document.querySelector(`a.sidebar-link[href="${path}"] span`);
    tt.textContent = active ? active.textContent.trim() : (document.title || 'Dashboard');
  }
});
</script>
{% endblock %}
